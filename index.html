import React, { useEffect, useState } from "react";
import { db } from "./firebase"; // Make sure this points to your Firebase config
import "./App.css";

const parValues = [4, 4, 3, 5, 4, 4, 3, 4, 4, 5, 4, 3, 4, 4, 5, 4, 4, 5];

function App() {
  const [players, setPlayers] = useState([]);
  const [scores, setScores] = useState({});
  const gameId = "default"; // You can make this dynamic later

  useEffect(() => {
    const scoresRef = db.ref(`games/${gameId}`);
    scoresRef.on("value", (snapshot) => {
      const data = snapshot.val() || {};
      setScores(data);
      setPlayers(Object.keys(data));
    });
  }, []);

  const handleScoreChange = (player, holeIndex, value) => {
    const newScore = parseInt(value);
    db.ref(`games/${gameId}/${player}/scores/${holeIndex}`).set(
      isNaN(newScore) ? "" : newScore
    );
  };

  const handleCommentChange = (player, holeIndex, comment) => {
    db.ref(`games/${gameId}/${player}/comments/${holeIndex}`).set(comment);
  };

  const addPlayer = () => {
    const name = prompt("Enter player name");
    if (name && !players.includes(name)) {
      db.ref(`games/${gameId}/${name}`).set({
        scores: Array(18).fill(""),
        comments: Array(18).fill(""),
      });
    }
  };

  const calculateTotal = (playerData) => {
    const playerScores = playerData?.scores || [];
    let playerTotal = 0;

    for (let i = 0; i < parValues.length; i++) {
      const score = parseInt(playerScores[i]);
      if (!isNaN(score)) {
        playerTotal += score;
      }
    }

    const parTotal = parValues.reduce((a, b) => a + b, 0);
    if (playerTotal === 0) return "--";

    const diff = playerTotal - parTotal;
    return diff === 0 ? "E" : (diff > 0 ? "+" : "") + diff;
  };

  return (
    <div className="App">
      <h2>Wordle Golf Scorecard</h2>
      <button onClick={addPlayer}>+ Add Player</button>
      <table>
        <thead>
          <tr>
            {Array.from({ length: 18 }, (_, i) => (
              <th key={i}>H{i + 1}</th>
            ))}
            <th>+/-</th>
          </tr>
        </thead>
        <tbody>
          {players.map((player) => {
            const playerData = scores[player] || {};
            return (
              <tr key={player}>
                {Array.from({ length: 18 }, (_, i) => {
                  const holeScore = playerData?.scores?.[i] ?? "";
                  const holeComment = playerData?.comments?.[i] ?? "";
                  return (
                    <td key={i}>
                      <input
                        type="number"
                        value={holeScore}
                        placeholder="-"
                        onChange={(e) =>
                          handleScoreChange(player, i, e.target.value)
                        }
                        style={{ width: "40px", textAlign: "center" }}
                      />
                      <br />
                      <input
                        type="text"
                        value={holeComment}
                        placeholder="ðŸ“"
                        onChange={(e) =>
                          handleCommentChange(player, i, e.target.value)
                        }
                        style={{ width: "60px" }}
                      />
                    </td>
                  );
                })}
                <td><strong>{calculateTotal(playerData)}</strong></td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
}

export default App;
